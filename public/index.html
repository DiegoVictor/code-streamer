<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code Streamer</title>
  <link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/21111996?s=400&u=5075e1fc41d55895f03595730d571afd00eff08c&v=4">
</head>
<body>
  <video id="video" width="720" controls></video>

  <script src="/js/cryptojs/buffer.min.js"></script>
  <script src="/js/cryptojs/core.js"></script>
  <script src="/js/cryptojs/lib-typedarrays.js"></script>
  <script src="/js/cryptojs/enc-base64.js"></script>
  <script src="/js/cryptojs/md5.js"></script>
  <script src="/js/cryptojs/evpkdf.js"></script>
  <script src="/js/cryptojs/cipher-core.js"></script>
  <script src="/js/cryptojs/aes.js"></script>
  <script>
    const video = document.getElementById('video');

    const mediaSource = new MediaSource();
    const mediaSourceUrl = URL.createObjectURL(mediaSource);

    video.src = mediaSourceUrl;

    video.addEventListener('canplay', () => {
      video.play();
    });

    function getStreamBuffer(url, range) {
      return fetch(url, {
        headers: {
          range: range || 'bytes 0-'
        }
      })
      .then(response => {
        return response.arrayBuffer().then(arrayBuffer => {
          return {
            arrayBuffer,
            range: response.headers.get('content-range')
          };
        })
      })
    }

    function decrypt (arrayBuffer, secret) {
      const cipherText = new TextDecoder().decode(arrayBuffer);
      const decrypted = CryptoJS.AES.decrypt(cipherText, secret)
        .toString(CryptoJS.enc.Utf8);

      return buffer.Buffer.from(decrypted, 'hex');
    }

    mediaSource.addEventListener('sourceopen', function() {
      const videoSourceBuffer = mediaSource.addSourceBuffer(
        'video/mp4; codecs="avc1.42E01E, mp4a.40.2"'
      );
      const videoUrl = '/videos/video.mp4';
      const secret = '6n2347856n234785nc623487c56n2347';

      function handleBuffer(response) {
        if (response && response.stream && response.range) {
          const reader = response.stream.getReader();

          return reader.read()
            .then(function ({ done, value }) {
              return handleChunk({
                done, value, range: response.range, reader
              });
            });
        }

        mediaSource.endOfStream();
        video.play();
      }

      function handleChunk ({ done, value, range, reader }) {
        if (done) {
          if (range) {
            getStreamingPart(url, range).then(handleBuffer);
          }
        }
        else {
          videoSourceBuffer.appendBuffer(value);
          videoSourceBuffer.addEventListener('updateend', function() {
            reader.read()
              .then(function (result) {
                return handleChunk({
                  done: result.done,
                  value: result.value,
                  range,
                  reader,
                })
              });
          }, {
            once: true
          });
        }
      }

      getStreamBuffer(videoUrl)
        .then(response => handleBuffer(response));
    });
  </script>
</body>
</html>
