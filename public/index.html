<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code Streamer</title>
  <link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/21111996?s=400&u=5075e1fc41d55895f03595730d571afd00eff08c&v=4">

  <style>
    body {
      margin: 0px;
    }

    #app {
      padding: 8px;
    }

  </style>
</head>
<body>
  <div id="app">
    <div class="video-container">
      <video ref="video" width="720"></video>
      <div class="video-controls">
        <div class="video-progress-timeline">
      </div>
    </div>
  </div>

  <script src="/js/cryptojs/buffer.min.js"></script>
  <script src="/js/cryptojs/core.js"></script>
  <script src="/js/cryptojs/lib-typedarrays.js"></script>
  <script src="/js/cryptojs/enc-base64.js"></script>
  <script src="/js/cryptojs/md5.js"></script>
  <script src="/js/cryptojs/evpkdf.js"></script>
  <script src="/js/cryptojs/cipher-core.js"></script>
  <script src="/js/cryptojs/aes.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script>
  <script>
    const video = document.getElementById('video');

    const mediaSource = new MediaSource();
    const mediaSourceUrl = URL.createObjectURL(mediaSource);

    video.src = mediaSourceUrl;

    video.addEventListener('canplay', () => {
      video.play();
    });

    function getStreamBuffer(url, range) {
      return fetch(url, {
        headers: {
          range: range || 'bytes 0-'
        }
      })
      .then(response => {
        return response.arrayBuffer().then(arrayBuffer => {
          return {
            arrayBuffer,
            range: response.headers.get('content-range')
          };
        })
      })
    }

    function decrypt (arrayBuffer, secret) {
      const cipherText = new TextDecoder().decode(arrayBuffer);
      const decrypted = CryptoJS.AES.decrypt(cipherText, secret)
        .toString(CryptoJS.enc.Utf8);

      return buffer.Buffer.from(decrypted, 'hex');
    }

    mediaSource.addEventListener('sourceopen', function() {
      const videoSourceBuffer = mediaSource.addSourceBuffer(
        'video/mp4; codecs="avc1.42E01E, mp4a.40.2"'
      );
      const videoUrl = '/videos/video.mp4';
      const secret = '6n2347856n234785nc623487c56n2347';

      function handleBuffer ({ arrayBuffer, range }) {
        videoSourceBuffer.appendBuffer(decrypt(arrayBuffer, secret));

        videoSourceBuffer.addEventListener('updateend', function() {
          const [, end, total] = range.replace('bytes ', '')
            .match(/\d+/g)
            .map(match => Number(match));

          if (end < total - 1) {
            getStreamBuffer(videoUrl, `bytes=${end + 1}-`)
              .then(response => handleBuffer(response));
          }
          else {
            mediaSource.endOfStream();
          }
        }, { once: true });
      }

      getStreamBuffer(videoUrl)
        .then(response => handleBuffer(response));
    });
  </script>
</body>
</html>
