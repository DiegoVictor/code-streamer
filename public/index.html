<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code Streamer</title>
  <link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/21111996?s=400&u=5075e1fc41d55895f03595730d571afd00eff08c&v=4">
</head>
<body>
  <video id="video" width="720" controls></video>
  <script>
    const video = document.getElementById('video');

    const mediaSource = new MediaSource();
    const url = URL.createObjectURL(mediaSource);

    video.src = url;

    async function getStreamingPart(url, range) {
      let bytes;

      if (!range) {
        bytes = 'bytes=0-';
      }
      else {
        const [start, end, total] = range.replace('bytes ', '').match(/\d+/g);

        if (Number(end) < Number(total - 1)) {
          bytes = 'bytes=' + (Number(end) + 1) + '-';
        }
      }

      if (bytes) {
        return fetch(url, {
          headers: {
            range: bytes,
          }
        })
        .then(function (response) {
          return {
            stream: response.body,
            range: response.headers.get('content-range')
          };
        });
      }

      return null;
    }

    mediaSource.addEventListener('sourceopen', function() {
      const videoSourceBuffer = mediaSource.addSourceBuffer(
        'video/mp4; codecs="avc1.42E01E, mp4a.40.2"'
      );
      const url = '/videos/video.mp4';
      let range;

      function handleBuffer(response) {
        if (response && response.stream && response.range) {
          const reader = response.stream.getReader();

          return reader.read()
            .then(function ({ done, value }) {
              return handleChunk({
                done, value, range: response.range, reader
              });
            });
        }

        mediaSource.endOfStream();
        video.play();
      }

      function handleChunk ({ done, value, range, reader }) {
        if (done) {
          if (range) {
            getStreamingPart(url, range).then(handleBuffer);
          }
        }
        else {
          videoSourceBuffer.appendBuffer(value);
          videoSourceBuffer.addEventListener('updateend', function() {
            reader.read()
              .then(function (result) {
                return handleChunk({
                  done: result.done,
                  value: result.value,
                  range,
                  reader,
                })
              });
          }, {
            once: true
          });
        }
      }

      getStreamingPart(url).then(handleBuffer)
    });
  </script>
</body>
</html>
